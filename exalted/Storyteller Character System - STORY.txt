&TEMPLATES_BASE [u(cobj,story)]=MORTAL|SOLAR|LUNAR|SIDEREAL|DRAGON-BLOODED|ALCHEMICAL
&TEMPLATES_2E [u(cobj,story)]=setunion(u(TEMPLATES_BASE),DRAGON-KING|GOD-BLOODED|JADEBORN|RAKSHA|SPIRIT|GHOST)
&TEMPLATES_3E [u(cobj,story)]=setunion(u(TEMPLATES_BASE),LIMINAL|GETIMIAN|EXIGENT,|,|)
&TEMPLATES_ESSENCE [u(cobj,story)]=u(TEMPLATES_3E)

&ENABLE_SHARDS [u(cobj,story)]=0

&CONSTELLATIONS [u(cobj,story)]=setunion(THE CORPSE|THE CROW|THE HAYWAIN|THE RISING SMOKE|THE SWORD|THE CAPTAIN|THE GULL|THE MAST|THE MESSENGER|THE SHIP'S WHEEL|THE EWER|THE LOVERS|THE MUSICIAN|THE PEACOCK|THE PILLAR|THE GUARDIANS|THE KEY|THE MASK|THE SORCERER|THE TREASURE TROVE|THE BANNER|THE GAUNTLET|THE QUIVER|THE SHIELD|THE SPEAR,if(u(ENABLE_SHARDS),u(CONSTELLATIONS_SHARDS)),|,|)
&CONSTELLATIONS_SHARDS [u(cobj,story)]=THE COMET|THE LIGHTNING BOLT

&PATHS [u(cobj,story)]=CELESTIAL AIR|CLEAR AIR|SOLID EARTH|YIELDING EARTH|BLAZING FIRE|FLICKERING FIRE|FLOWING WATER|SHIMMERING WATER|GROWING WOOD|SHAPING WOOD|GLORIOUS CONSUMPTION|COAGULATED EUCHARIST|TECHNOMORPHIC TRANSCENDANCE|ECSTATIC ARMAGEDDON|TORMENTED BODHISATTVA

&VIRTUES [u(cobj,story)]=COMPASSION|CONVICTION|TEMPERANCE|VALOR

&GRACES [u(cobj,story)]=WAY|SWORD|STAFF|CUP|RING|HEART

&SORCERY [u(cobj,story)]=TERRESTRIAL|CELESTIAL|SOLAR
&NECROMANCY [u(cobj,story)]=SHADOWLANDS|LABYRINTH|VOID
&PROTOCOLS [u(cobj,story)]=MAN-MACHINE|GOD-MACHINE

&TRAITS`ADVANTAGES [u(cobj,story)]=ESSENCE|WILLPOWER

&TRAITS`ATTRIBUTES`PHYSICAL [u(cobj,story)]=STRENGTH|DEXTERITY|STAMINA
&TRAITS`ATTRIBUTES`SOCIAL [u(cobj,story)]=CHARISMA|MANIPULATION|APPEARANCE
&TRAITS`ATTRIBUTES`MENTAL [u(cobj,story)]=PERCEPTION|INTELLIGENCE|WITS


&TRAITS`ATTRIBUTES_2E [u(cobj,story)]=setunion(setunion(u(TRAITS`ATTRIBUTES`PHYSICAL),u(TRAITS`ATTRIBUTES`SOCIAL),|,|),u(TRAITS`ATTRIBUTES`MENTAL),|,|)
&TRAITS`ATTRIBUTES_3E [u(cobj,story)]=u(TRAITS`ATTRIBUTES_2E)
&TRAITS`ATTRIBUTES_ESSENCE [u(cobj,story)]=FORCE|FINESSE|FORTITUDE
&TRAITS`ATTRIBUTES`CAN_FAVOR [u(Cobj,story)]=u(traits`attributes)

&TRAITS`ABILITIES_2E [u(cobj,story)]=setunion(ARCHERY|ATHLETICS|AWARENESS|BUREAUCRACY|CRAFT|DODGE|INTEGRITY|INVESTIGATION|LARCENY|LINGUISTICS|LORE|MARTIAL ARTS|MEDICINE|MELEE|OCCULT|PERFORMANCE|PRESENCE|RESISTANCE|RIDE|SAIL|SOCIALIZE|STEALTH|SURVIVAL|THROWN|WAR,if(u(ENABLE_SHARDS),u(TRAITS`ABILITIES_SHARDS)),|,|)
&TRAITS`ABILITIES_SHARDS [u(cobj,story)]=FIREARMS|DRIVE
&TRAITS`ABILITIES_3E [u(cobj,story)]=setunion(u(TRAITS`ABILITIES_2E),BRAWL,|,|)
&TRAITS`ABILITIES`UNPURCHASABLE_3E [u(cobj,story)]=MARTIAL ARTS|CRAFT
&TRAITS`ABILITIES_ESSENCE [u(cobj,story)]=AWARENESS|ATHLETICS|CLOSE COMBAT|CRAFT|EMBASSY|INTEGRITY|NAVIGATE|PERFORMANCE|PHYSIQUE|PRESENCE|RANGED COMBAT|SAGACITY|STEALTH|WAR
&TRAITS`ABILITIES`CAN_FAVOR_2E [u(cobj,story)]=u(TRAITS`ABILITIES_2E)
&TRAITS`ABILITIES`CAN_FAVOR_3E [u(cobj,story)]=setdiff(u(TRAITS`ABILITIES_3E),MARTIAL ARTS,|,|)
&TRAITS`ABILITIES`CAN_SUPERNAL [u(cobj,story)]=u(TRAITS`ABILITIES_3E)

&TEMPLATES`MORTAL`FIELD [u(cobj,story)]=PROFESSION
&TEMPLATES`MORTAL`FIELD`PROFESSION [u(cobj,story)]=WARRIOR|PRIEST|SAVANT|CRIMINAL|BROKER

&TEMPLATES`GHOST`FIELD [u(cobj,story)]=u(TEMPLATES`MORTAL`FIELD)
&TEMPLATES`GHOST`FIELD`PROFESSION [u(cobj,story)]=u(TEMPLATES`MORTAL`FIELD`PROFESSION)

&TEMPLATES`SOLAR`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`SOLAR`FIELD`CASTE [u(cobj,story)]=DAWN|ZENITH|TWILIGHT|NIGHT|ECLIPSE
&TEMPLATES`SOLAR`CHARMS [u(cobj,story)]=u(TRAITS`ABILITIES)

&TEMPLATES`ABYSSAL`FIELD [u(cobj,story)]=CASTE|LIEGE
&TEMPLATES`ABYSSAL`FIELD`CASTE [u(cobj,story)]=DUSK|MIDNIGHT|DAYBREAK|DAY|MOONSHADOW
&TEMPLATES`ABYSSAL`CHARMS [u(cobj,story)]=u(TEMPLATES`SOLAR`CHARMS)

&TEMPLATES`DRAGON-BLOODED`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`DRAGON-BLOODED`FIELD`ASPECT [u(cobj,story)]=AIR|EARTH|FIRE|WATER|WOOD
&TEMPLATES`DRAGON-BLOODED`CHARMS [u(cobj,story)]=u(TEMPLATES`SOLAR`CHARMS)

&TEMPLATES`LUNAR`FIELD [u(cobj,story)]=TOTEM
&TEMPLATES`LUNAR`FIELD`CASTE [u(cobj,story)]=FULL MOON|CHANGING MOON|NO MOON|WANING MOON|WAXING MOON|HALF-MOON|CASTELESS
&TEMPLATES`LUNAR`CHARMS_2E [u(cobj,story)]=setunion(u(TRAITS`ATTRIBUTES),KNACKS,|,|)
&TEMPLATES`LUNAR`CHARMS_3E [u(cobj,story)]=setunion(u(TRAITS`ATTRIBUTES),UNIVERSAL,|,|)

&TEMPLATES`INFERNAL`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`INFERNAL`FIELD`CASTE_3E [u(cobj,story)]=AZIMUTH|ASCENDANT|HORIZON|NADIR|PENUMBRA
&TEMPLATES`INFERNAL`FIELD`CASTE_2E [u(cobj,story)]=SLAYER|FIEND|SCOURGE|MALEFACTOR|DEFILER
&TEMPLATES`INFERNAL`CHARMS_2E [u(cobj,story)]=MALFEAS|CECELYNE|EBON DRAGON|SHE WHO LIVES IN HER NAME|ADORJAN|HERETICAL

&TEMPLATES`SIDEREAL`FIELD [u(cobj,story)]=CASTE|FACTION
&TEMPLATES`SIDEREAL`FIELD`CASTE [u(cobj,story)]=JOURNEYS|SERENITY|BATTLES|SECRETS|ENDINGS
&TEMPLATES`SIDEREAL`CHARMS [u(cobj,story)]=u(TEMPLATES`SOLAR`CHARMS)

&TEMPLATES`LIMINAL`FIELD [u(cobj,story)]=ASPECT
&TEMPLATES`LIMINAL`FIELD`ASPECT [u(cobj,story)]=BLOOD|BREATH|FLESH|MARROW|SOIL

&TEMPLATES`GETIMIAN`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`GETIMIAN`FIELD`CASTE [u(cobj,story)]=SPRING|SUMMER|AUTUMN|WINTER

&TEMPLATES`ALCHEMICAL`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`ALCHEMICAL`FIELD`CASTE [u(cobj,story)]=ORICHALCUM|MOONSILVER|JADE|STARMETAL|SOULSTEEL|ADAMANT
&TEMPLATES`ALCHEMICAL`CHARMS [u(cobj,story)]=setunion(u(TRAITS`ATTRIBUTES),COMBAT|MASS COMBAT|SURVIVAL|SPEED AND MOBILITY|SOCIAL|STEALTH AND DISGUISE|ANALYTIC AND COGNITIVE|LABOR AND UTILITY|SPIRITUAL,|,|)

&TEMPLATES`GOD-BLOODED`FIELD [u(cobj,story)]=LINEAGE
&TEMPLATES`GOD-BLOODED`FIELD`LINEAGE [u(cobj,story)]=GOD|DEMON|ELEMENTAL|GHOST|FAE|SOLAR|LUNAR|SIDEREAL|ABYSSAL|INFERNAL

&TEMPLATES`RAKSHA`FIELD [u(cobj,story)]=CASTE
&TEMPLATES`RAKSHA`FIELD`CASTE [u(cobj,story)]=DIPLOMAT|COURTIER|IMPERIAL RAKSHA|SCRIBE|ENTERTAINER|LUMINARY|ESHU|ORNAMENTAL RAKSHA|WARRIOR|ANARCH|XIA|CATAPHRACT|WORKER|PANJANDRUM|ARTISAN|STRATEGOS|GUIDE|HARBINGER|VAGABOND|NOMAD|FERRYMAN|HERALD|SKALD|DRAGOON|ATTENDANT
&TEMPLATES`RAKSHA`CHARMS [u(obj,caste)]=u(GRACES)

&TEMPLATES`DRAGON-KING`FIELD [u(cobj,story)]=BREED
&TEMPLATES`DRAGON-KING`FIELD`BREED [u(cobj,story)]=ANKLOK|MOSOK|PTEROK|RAPTOK

&TEMPLATES`SPIRIT`FIELD [u(obj,data)]=NATURE
&TEMPLATES`SPIRIT`FIELD`NATURE [u(cobj,story)]=GOD|DEMON|ELEMENTAL
&TEMPLATES`SPIRIT`CHARMS_2E [u(cobj,story)]=setunion(UNIVERSAL,u(VIRTUES),|,|)
&TEMPLATES`SPIRIT`CHARMS_3E [u(cobj,story)]=UNIVERSAL

&CHARMS [u(cobj,story)]=setdiff(u(TEMPLATES),MORTAL|DRAGON-KING|GOD-BLOODED,|,|)

&SPECIALTIES [u(cobj,story)]=setunion(u(TRAITS`ATTRIBUTES),u(TRAITS`ABILITIES`SETTABLE),|,|)

&NATIVE_CHARMS [u(cobj,story)]=localize(if(match(SOLAR|LUNAR|SIDEREAL|DRAGON-BLOODED|ALCHEMICAL|JADEBORN|RAKSHA|SPIRIT|GHOST|LIMINAL|GETIMIAN|EXIGENT,u(setr,template,u(FUN`GETTEMPLATE,%0)),|),%q<template>),switch(%q<template>,GOD-BLOODED,switch(u(setr,splat,u(FUN`GETSPLAT,%0)),GOD,SPIRIT,DEMON,SPIRIT,ELEMENTAL,SPIRIT,FAE,RAKSHA,%q<splat>)))

&FUN`GETSPLAT [u(cobj,story)]=get(%0/D`FIELD`[switch(u(FUN`GETTEMPLATE,%0),DRAGON-BLOODED,ASPECT,LIMINAL,ASPECT,GOD-BLOODED,LINEAGE,DRAGON-KING,BREED,SPIRIT,NATURE,MORTAL,PROFESSION,GHOST,PROFESSION,CASTE)])

@@ Setters

&CHAR`SET`ABILITY [u(cobj,story)]=@attach %!/INC`PARTIAL=%1,u(TRAITS`ABILITIES`SETTABLE),|,abil,Ability;@attach %!/DO`SET`STATIC=%0,Abilities,%q<abil>,%2

&CHAR`SET`CRAFT [u(cobj,story)]=@attach %!/DO`SET`CUSTOM=%0,Crafts,%1,%2

&CHAR`SET`STYLE [u(cobj,story)]=@attach %!/DO`SET`CUSTOM=%0,Styles,%1,%2

&INC`VALID`SPECIALTY_NAME [u(cobj,story)]=@check strlen(u(setr,specialty_name,u(capnames,squish(%0))))=@attach %!/INC`MSG=ERROR: No specialty name entered!;@check regmatchi(%q<specialty_name>,^\(\\w+|%b\)+$)=@attach %!/INC`MSG=ERROR: Specialty names must be comprised purely of alphanumeric characters and spaces.

&CHAR`SET`SPECIALTY [u(cobj,story)]=@attach %!/INC`PARTIAL=before(%1,/),u(SPECIALTIES),spec,Specialty;@attach %!/INC`VALID`SPECIALTY_NAME=after(%1,/);@attach %!/DO`SET`CUSTOM=%0,Specialties|%q<spec>,%q<specialty_name>,%2

&CHAR`SET`CHARM [u(cobj,story)]=@attach %!/INC`PARTIAL=elements(%1,1,|),u(CHARMS),|,ctype,Charm Type;@attach %!/INC`PARTIAL=elements(%1,2,|),u(TEMPLATES`%q<ctype>`CHARMS),|,ccat,Charm Category;@attach %!/DO`SET`CUSTOM=%0,Charms|%q<ctype>|%q<ccat>,elements(%1,3,|),%2

&CHAR`SET`SPELL [u(cobj,story)]=@attach %!/INC`PARTIAL=elements(%1,1,|),SORCERY|NECROMANCY|PROTOCOLS,|,stype,Spell Type;@attach %!/INC`PARTIAL=elements(%1,2,|),u(%q<stype>),|,scircle,Spell Circle;@attach %!/DO`SET`CUSTOM=%0,Spells|%q<stype>|%q<scircle>,elements(%1,%3,|),%2;

&DO`SET`TAG [u(cobj,story)]=@attach %!/INC`PARTIAL=elements(%1,1,|),ATTRIBUTES|ABILITIES,|,favtype,Category;@check u(FUN`VALIDATE_WORDPOWERS,u(setr,wordpowers,u(FUN`CLEAN_WORDPOWERS,%2)))=@attach %!/INC`MSG=ERROR: One or more traits did not pass validation.;th u(setq,wordpowers,u(FUN`STRIPNUM_WORDPOWERS,%q<wordpowers>));th u(setq,valtraits,u(TRAITS`%q<favtype>`%3));@dolist/inline/delimit | %q<wordpowers>={@check match(%q<valtraits>,%i0,|)=@attach %!/INC`MSG=Invalid %q<favtype>: %i0};@dolist/inline/delimit | %q<wordpowers>={@attach %!/FLAG`TRAIT=%0,%q<favtype>,%i0,1,1,get(%#/D`ID),%4,%5,1,1}

&CHAR`ADD`FAVORED [u(cobj,story)]=@attach %!/DO`SET`TAG=%0,%1,%2,CAN_FAVOR,1,1
&CHAR`ADD`SUPERNAL [u(cobj,story)]=@attach %!/DO`SET`TAG=%0,%1,%2,CAN_SUPERNAL,1,2
&CHAR`REM`FAVORED [u(cobj,story)]=@attach %!/DO`SET`TAG=%0,%1,%2,CAN_FAVOR,1,0
&CHAR`REM`SUPERNAL [u(cobj,story)]=@attach %!/DO`SET`TAG=%0,%1,%2,CAN_SUPERNAL,1,0


&CHAR`TAG`ABILITY [u(cobj,story)]=@attach %!/DO`TAG`STAT`1=%0,%1,%2,Ability,3;@attach %!/INC`MSG=u(setr,msg,ansi(hw,name(%0))'s %q<msg>);@attach %!/INC`MSG`CHAN=%q<msg>

&CHAR`TAG`ATTRIBUTE [u(cobj,story)]=@attach %!/DO`TAG`STAT`1=%0,%1,%2,Attribute,2;@attach %!/INC`MSG=u(setr,msg,ansi(hw,name(%0))'s %q<msg>);@attach %!/INC`MSG`CHAN=%q<msg>